<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Drills (Adaptive)</title>
  <style>
    :root {
      --blue:#3b82f6; --blue-d:#2563eb; --bg:#f8fafc; --good:#0ea34b; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:2rem;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a;display:flex;flex-direction:column;align-items:center}
    h1{margin:0 0 1rem}
    #menu{width:100%;max-width:840px}
    #menu h2{text-align:center;margin:0 0 .75rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem}
    .grid button,#back{border:0;border-radius:10px;padding:.7rem 1rem;cursor:pointer;background:var(--blue);color:#fff;font-weight:600;box-shadow:0 4px 14px rgba(0,0,0,.08)}
    .grid button:hover,#back:hover{background:var(--blue-d)}
    #quiz{width:100%;max-width:560px;text-align:center}
    #question{font-size:1.9rem;margin:1rem 0}
    #answer{width:240px;padding:.6rem .75rem;font-size:1.2rem;text-align:center;border:2px solid #cbd5e1;border-radius:10px;background:#fff}
    #answer:disabled{background:#e2e8f0}
    #feedback{min-height:1.6rem;margin:.75rem 0 0;font-size:1.2rem}
    .correct{color:var(--good)} .wrong{color:var(--bad)}
    .row{display:flex;gap:.6rem;justify-content:center;margin-top:1rem}
    .visually-hidden{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <h1>Math Drills</h1>

  <div id="menu">
    <h2>Choose a drill</h2>
    <div class="grid">
      <button data-drill="mult12">12 × (1–15)</button>
      <button data-drill="mult10">Multiplication 1–10 (no ×1)</button>
      <button data-drill="mult15">Multiplication 1–15 (no ×1)</button>
      <button data-drill="add2">Two-digit addition</button>
      <button data-drill="squares">Perfect squares</button>
      <button data-drill="cubes">Perfect cubes</button>
      <button data-drill="roots">√2, √3, √5 (3 decimals)</button>
      <button data-drill="exp2">Powers of 2 (1–10)</button>
      <button data-drill="exp3">Powers of 3 (1–5)</button>
      <button data-drill="exp4">Powers of 4 (1–5)</button>
      <button data-drill="exp5">Powers of 5 (1–5)</button>
      <button data-drill="decimals">Fractions → decimals</button>
    </div>
  </div>

  <div id="quiz" hidden>
    <div id="question"></div>
    <label for="answer" class="visually-hidden">Answer</label>
    <input id="answer" type="text" inputmode="decimal" autocomplete="off" />
    <div id="feedback" aria-live="polite"></div>
    <div class="row">
      <button id="back">Back</button>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    // Fractions for decimal drills
    const FRACTIONS=[];
    for(let i=1;i<5;i++) FRACTIONS.push([i,5]);   // 1/5..4/5
    for(let i=1;i<6;i++) FRACTIONS.push([i,6]);   // 1/6..5/6
    for(let i=1;i<7;i++) FRACTIONS.push([i,7]);   // 1/7..6/7
    for(let i=1;i<8;i++) FRACTIONS.push([i,8]);   // 1/8..7/8
    [[1,9],[1,11],[1,12],[1,16],[1,32]].forEach(f=>FRACTIONS.push(f));

    // ===== Adaptive bank builder (finite sets) =====
    function buildBank(key){
      const items=[], weights=new Map();
      const add=(id,text,ans,type='int')=>{ items.push({id,text,ans,type}); weights.set(id,1); };

      if(key==='mult12'){
        for(let b=1;b<=15;b++) add(`12x${b}`,`12 × ${b}`,12*b,'int');
      }
      if(key==='mult10' || key==='mult15'){
        const N = key==='mult10'?10:15;
        for(let a=2;a<=N;a++){
          for(let b=2;b<=N;b++){
            add(`${a}x${b}`,`${a} × ${b}`,a*b,'int'); // exclude ×1 by starting at 2
          }
        }
      }
      if(key==='squares'){ for(let n=1;n<=20;n++) add(`sq${n}`,`${n}²`,n*n,'int'); }
      if(key==='cubes'){ for(let n=1;n<=10;n++) add(`cu${n}`,`${n}³`,n*n*n,'int'); }
      if(key==='roots'){ [2,3,5].forEach(r=>add(`r${r}`,`√${r} ≈ (3 decimals)`,parseFloat(Math.sqrt(r).toFixed(3)),'float')); }
      if(key==='exp2'){ for(let e=1;e<=10;e++) add(`2^${e}`,`2^${e}`,2**e,'int'); }
      if(key==='exp3'){ for(let e=1;e<=5;e++) add(`3^${e}`,`3^${e}`,3**e,'int'); }
      if(key==='exp4'){ for(let e=1;e<=5;e++) add(`4^${e}`,`4^${e}`,4**e,'int'); }
      if(key==='exp5'){ for(let e=1;e<=5;e++) add(`5^${e}`,`5^${e}`,5**e,'int'); }
      if(key==='decimals'){ for(const [n,d] of FRACTIONS) add(`${n}/${d}`,`${n}/${d} ≈ (3 decimals)`,parseFloat((n/d).toFixed(3)),'float'); }

      return {items,weights};
    }

    function pickWeighted(bank){
      let total=0; for(const id of bank.weights.keys()) total+=bank.weights.get(id);
      let r=Math.random()*total;
      for(const it of bank.items){
        r-=bank.weights.get(it.id);
        if(r<=0) return it;
      }
      return bank.items[bank.items.length-1];
    }

    function updateWeight(bank,id,correct){
      const w=bank.weights.get(id) ?? 1;
      if(correct){
        bank.weights.set(id, Math.max(0.3, w - 0.2));   // good → show less often
      }else{
        bank.weights.set(id, Math.min(5,   w + 1));     // mistake → show more often
      }
    }

    // ===== Two-digit addition: open set with mistake bucket =====
    const addBucket=[]; // {key,a,b,count}
    function pickAdd(){
      if(addBucket.length && Math.random()<0.6){
        // sample by count
        const total = addBucket.reduce((s,x)=>s+x.count,0);
        let r=Math.random()*total;
        for(const m of addBucket){ r-=m.count; if(r<=0) return {id:m.key,text:`${m.a} + ${m.b}`,ans:m.a+m.b,type:'int',a:m.a,b:m.b}; }
      }
      const a=rand(10,99), b=rand(10,99);
      return {id:`${a}+${b}`, text:`${a} + ${b}`, ans:a+b, type:'int', a,b};
    }
    function recordAddResult(item,correct){
      const idx=addBucket.findIndex(x=>x.key===item.id);
      if(correct){
        if(idx>-1){ addBucket[idx].count--; if(addBucket[idx].count<=0) addBucket.splice(idx,1); }
      }else{
        if(idx>-1){ addBucket[idx].count = Math.min(5, addBucket[idx].count+1); }
        else addBucket.push({key:item.id,a:item.a,b:item.b,count:2}); // show again soon
      }
    }

    // ===== UI / Flow =====
    const menu=document.getElementById('menu');
    const quiz=document.getElementById('quiz');
    const qEl=document.getElementById('question');
    const aEl=document.getElementById('answer');
    const fb=document.getElementById('feedback');
    const back=document.getElementById('back');

    const DELAY_OK=650, DELAY_BAD=1100; // ms
    let mode=null;        // drill key
    let bank=null;        // {items,weights} for finite drills
    let current=null;     // current question item
    let awaiting=false;   // lock while auto-advancing
    let timer=null;

    document.querySelectorAll('#menu [data-drill]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        mode=btn.dataset.drill;
        bank = (mode==='add2') ? null : buildBank(mode);
        menu.hidden=true; quiz.hidden=false; ask();
      });
    });

    back.addEventListener('click',()=>{
      clearTimeout(timer); timer=null; awaiting=false;
      quiz.hidden=true; menu.hidden=false; aEl.value=''; fb.textContent=''; fb.className='';
      mode=null; bank=null; current=null;
    });

    function ask(){
      awaiting=false; clearTimeout(timer); timer=null;
      if(mode==='add2'){ current = pickAdd(); }
      else { current = pickWeighted(bank); }
      qEl.textContent=current.text;
      aEl.disabled=false; aEl.value=''; fb.textContent=''; fb.className='';
      aEl.focus();
    }

    function check(){
      const raw=aEl.value.trim(); if(!raw || awaiting) return;
      let ok=false;
      if(current.type==='float'){
        const user=parseFloat(raw);
        if(!Number.isNaN(user) && Math.abs(user-current.ans)<0.01) ok=true;
      }else{
        const user=parseInt(raw,10);
        if(!Number.isNaN(user) && user===current.ans) ok=true;
      }

      if(ok){ fb.textContent='✅ Correct!'; fb.className='correct'; }
      else{
        fb.textContent = `❌ Incorrect (Answer: ${current.type==='float'?current.ans.toFixed(3):String(current.ans)})`;
        fb.className='wrong';
      }
      aEl.disabled=true; awaiting=true;

      // adapt
      if(mode==='add2') recordAddResult(current,ok);
      else updateWeight(bank,current.id,ok);

      // auto-advance
      const delay = ok ? DELAY_OK : DELAY_BAD;
      timer=setTimeout(ask, delay);
    }

    // Enter submits; auto-advance happens inside check()
    aEl.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ e.preventDefault(); check(); }
    });
  </script>
</body>
</html>
