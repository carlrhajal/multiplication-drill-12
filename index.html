<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b1220">
  <title>Math Drills ‚Äî Dark + Stats + Division (Mobile)</title>
  <style>
    :root{
      --bg:#0b1220; --surface:#111a2b; --muted:#1a2440;
      --text:#e5e7eb; --subtle:#aeb6c2;
      --blue:#3b82f6; --blue-d:#2563eb;
      --good:#16a34a; --bad:#ef4444;
      --shadow:0 10px 28px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:24px;
      padding-left:max(24px, env(safe-area-inset-left));
      padding-right:max(24px, env(safe-area-inset-right));
      padding-top:max(24px, env(safe-area-inset-top));
      padding-bottom:max(24px, env(safe-area-inset-bottom));
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; gap:16px;
      -webkit-tap-highlight-color: transparent;
    }
    h1{margin:0 0 4px; font-size:clamp(1.25rem, 3.8vw, 1.6rem); letter-spacing:.2px}
    .sub{color:var(--subtle); font-size:clamp(.9rem, 2.8vw, .95rem)}

    button,input,select{touch-action:manipulation}

    .topbar{width:100%; max-width:1000px; display:flex; justify-content:space-between; align-items:center; position:relative}
    .ghost{
      background:transparent; color:var(--text); border:1px solid var(--muted);
      padding:.6rem .9rem; border-radius:999px; cursor:pointer; min-height:48px;
    }
    .ghost:hover{background:var(--muted)}

    .panel{width:100%; max-width:1000px; background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    #menu h2,#settings h2{margin:0 0 .6rem; font-size:clamp(1.05rem, 3.8vw, 1.2rem)}
    .mode-row{display:flex; gap:12px; align-items:center; margin:.25rem 0 .75rem; flex-wrap:wrap}
    .mode-row label{display:flex; gap:.45rem; align-items:center; padding:.25rem .5rem; border-radius:999px; background:#0f1a30}
    .badge{background:var(--muted); color:var(--text); border-radius:999px; padding:.25rem .6rem; font-size:.9rem}

    .grid{display:grid; gap:.6rem; grid-template-columns:repeat(auto-fit, minmax(220px,1fr));}
    .grid button,#back,.pill,.danger,#submitBtn{
      border:0; border-radius:12px; padding:.85rem 1rem; cursor:pointer; font-weight:600;
      box-shadow:0 6px 18px rgba(0,0,0,.25); min-height:48px;
    }
    .grid button,#back,.pill,#submitBtn{ background:var(--blue); color:#fff; }
    .grid button:hover,#back:hover,.pill:hover,#submitBtn:hover{ background:var(--blue-d); }
    .danger{ background:#b91c1c; color:#fff } .danger:hover{ background:#991b1b }

    #quiz{max-width:720px; margin-inline:auto;}
    #hud{display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; margin:.25rem 0 .5rem}
    .pill{background:#0f1a30}
    #question{
      background:var(--muted); border-radius:var(--radius); padding:14px;
      font-size:clamp(1.4rem, 7vw, 1.9rem); text-align:center; margin:.6rem 0;
    }
    #answer{
      width:min(420px, 100%); padding:1rem .9rem; font-size:clamp(1.1rem, 5.5vw, 1.25rem);
      text-align:center; border:2px solid #2a3558; border-radius:12px; background:#0e1730; color:var(--text);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03); min-height:52px;
    }
    #answer:disabled{opacity:.7}
    #feedback{min-height:1.4rem; margin:.6rem 0 0; font-size:clamp(1rem, 4.5vw, 1.1rem)}
    .correct{color:var(--good)} .wrong{color:var(--bad)}
    .row{display:flex; gap:.6rem; justify-content:center; margin-top:.8rem; flex-wrap:wrap}
    .visually-hidden{position:absolute; left:-9999px}

    #settings .controls{display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; margin:.5rem 0 .75rem}
    select{background:#0e1730; color:var(--text); border:1px solid #2a3558; border-radius:10px; padding:.6rem .7rem; min-height:44px;}
    table{width:100%; border-collapse:collapse; margin-top:.5rem; font-size:.95rem}
    th,td{padding:.55rem .6rem; text-align:left; border-bottom:1px solid #1e2a4a}
    th{color:#b9c2d0; font-weight:600}
    tbody tr:hover{background:#0f1934}
    .mono{font-variant-numeric:tabular-nums}
    .small{font-size:.85rem; color:#c7ceda}
    .right{text-align:right}
    .drilltag{background:#0f1a30; padding:.15rem .5rem; border-radius:999px; font-size:.8rem}

    /* Modal */
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; z-index:50;}
    .modal[hidden]{display:none}
    .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.6)}
    .sheet{position:relative; background:var(--surface); border-radius:16px; box-shadow:var(--shadow); width:min(980px, 100%); max-height:85vh; overflow:auto; padding:14px}
    .sheet h3{margin:0 0 .5rem}

    /* COMPACT reference visuals */
    .refgrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(128px,1fr)); gap:.35rem}
    .card{background:#0f1a30; border:1px solid #223055; border-radius:10px; padding:.4rem .5rem}
    .card h4{margin:.05rem 0 .2rem; font-size:.95rem; color:#d6dbe6}
    .card table{font-size:.9rem}
    .card th,.card td{padding:.3rem .45rem; border-bottom:1px solid #1b2746}
    .card tbody tr:hover{background:#0c1430}
    .tighttable{font-size:.88rem}

    .close{position:absolute; top:8px; right:8px; background:#0f1a30; border:1px solid #223055; border-radius:10px; color:var(--text); padding:.3rem .5rem; cursor:pointer}

    /* Mobile tweaks */
    #submitBtn{display:none}
    @media (max-width: 640px){
      body{padding:16px; padding-bottom:max(16px, env(safe-area-inset-bottom));}
      .panel{padding:14px}
      .grid{grid-template-columns:1fr}
      #hud{position:sticky; top:calc(56px + env(safe-area-inset-top)); z-index:5}
      .topbar{position:sticky; top:0; z-index:6}
      #answer{width:100%}
      #submitBtn{display:inline-block; width:100%; margin-top:.6rem}
      #back{width:100%}
      .refgrid{grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}
    }
  </style>
</head>
<body>
  <div class="topbar panel" style="display:flex; gap:12px; align-items:center;">
    <div>
      <h1>Math Drills</h1>
      <div class="sub">Dark mode ‚Ä¢ adaptive practice ‚Ä¢ sprint ‚Ä¢ stats</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <button id="openSettings" class="ghost">‚öôÔ∏è Settings & Stats</button>
    </div>
  </div>

  <!-- MENU -->
  <div id="menu" class="panel">
    <h2>Choose a drill</h2>
    <div class="mode-row">
      <label><input type="radio" name="mode" value="practice" checked> Practice</label>
      <label><input type="radio" name="mode" value="sprint"> 1-min Sprint</label>
      <span id="bestBadge" class="badge" hidden>Best: <b id="bestMenu">0</b></span>
    </div>
    <div class="grid">
      <button data-drill="mixed">Mixed (no addition; no zero-cancel)</button>
      <button data-drill="mult12">12 √ó (1‚Äì15)</button>
      <button data-drill="mult16">16 √ó (1‚Äì11)</button><!-- NEW -->
      <button data-drill="mult1216">12√ó & 16√ó (combo)</button><!-- NEW -->
      <button data-drill="mult15x">15 √ó (2‚Äì15)</button>
      <button data-drill="mult10">Multiplication 1‚Äì10 (no √ó1, downweight easy)</button>
      <button data-drill="mult15">Multiplication 1‚Äì15 (no √ó1, downweight easy)</button>
      <button data-drill="div">Division (tables ‚â§20)</button>
      <button data-drill="divZeros">Division (zero-canceling)</button>
      <button data-drill="add2">Two-digit addition</button>
      <button data-drill="sub2">Two-digit subtraction</button>
      <button data-drill="squares">Perfect squares (1¬≤‚Äì15¬≤)</button>
      <button data-drill="cubes">Perfect cubes (1¬≥‚Äì10¬≥)</button>
      <button data-drill="roots">‚àö2, ‚àö3, ‚àö5 (3 decimals)</button>
      <button data-drill="exp2">Powers of 2 (1‚Äì10)</button>
      <button data-drill="exp3">Powers of 3 (1‚Äì5)</button>
      <button data-drill="exp4">Powers of 4 (1‚Äì5)</button>
      <button data-drill="exp5">Powers of 5 (1‚Äì5)</button>
      <button data-drill="decimals">Fractions ‚Üí decimals</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="panel" hidden>
    <div id="hud" hidden>
      <span id="hudDrill" class="pill">‚Äî</span>
      <span id="hudTimer" class="pill" hidden>‚è±Ô∏è <b id="tLeft">60</b>s</span>
      <span id="hudScore" class="pill" hidden>Score: <b id="score">0</b></span>
      <span id="hudBest" class="pill" hidden>Best: <b id="best">0</b></span>
      <button id="refBtn" class="ghost" hidden>üìò Reference</button>
    </div>

    <div id="question"></div>
    <label for="answer" class="visually-hidden">Answer</label>
    <div style="display:flex; justify-content:center;">
      <input id="answer" type="text" inputmode="decimal" enterkeyhint="go" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    </div>
    <button id="submitBtn" class="pill" aria-label="Check answer (mobile)">Check / Next</button>
    <div id="feedback" aria-live="polite"></div>
    <div id="endpanel"></div>

    <div class="row">
      <button id="back">Back</button>
    </div>
  </div>

  <!-- SETTINGS / STATS -->
  <div id="settings" class="panel" hidden>
    <h2>Settings & Stats</h2>
    <div class="controls">
      <label>Filter drill:
        <select id="fltDrill">
          <option value="">All</option>
          <option value="mixed">Mixed</option>
          <option value="mult12">12 √ó</option>
          <option value="mult16">16 √ó</option><!-- NEW -->
          <option value="mult1216">12√ó & 16√ó</option><!-- NEW -->
          <option value="mult15x">15 √ó (2‚Äì15)</option>
          <option value="mult10">Mult 1‚Äì10</option>
          <option value="mult15">Mult 1‚Äì15</option>
          <option value="div">Division</option>
          <option value="divZeros">Division (zero-canceling)</option>
          <option value="add2">Addition</option>
          <option value="sub2">Subtraction</option>
          <option value="squares">Squares</option>
          <option value="cubes">Cubes</option>
          <option value="roots">Roots</option>
          <option value="exp2">2^</option>
          <option value="exp3">3^</option>
          <option value="exp4">4^</option>
          <option value="exp5">5^</option>
          <option value="decimals">Decimals</option>
        </select>
      </label>
      <label>Sort by:
        <select id="fltSort">
          <option value="wrongs">Most wrongs</option>
          <option value="rate">Lowest accuracy</option>
          <option value="recent">Most recent miss</option>
          <option value="attempts">Most attempts</option>
        </select>
      </label>
      <button id="clearStats" class="danger">Clear mistake stats</button>
      <button id="clearScores" class="ghost">Clear high scores</button>
      <button id="closeSettings" class="ghost" style="margin-left:auto">Back to menu</button>
    </div>
    <div id="statsContainer"></div>
  </div>

  <!-- REFERENCE MODAL -->
  <div id="refModal" class="modal" hidden>
    <div class="backdrop" id="refCloseBg"></div>
    <div class="sheet">
      <button class="close" id="refCloseBtn">‚úñ</button>
      <h3 id="refTitle">Reference</h3>
      <div id="refContent"></div>
    </div>
  </div>

  <script>
    /******** Helpers & constants ********/
    const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const SPRINT_SECONDS=60;
    const SIMPLE_BIAS=0.35; // lower => rarer easy facts (mult/div)
    const isSimple=(a,b)=> (a<=3||b<=3||a===5||b===5||a===10||b===10);
    const fmt=n=> n.toLocaleString('en-CA');
    const parseIntClean = s => { const cleaned = s.replace(/,/g,'').trim(); const v = parseInt(cleaned,10); return Number.isNaN(v) ? NaN : v; };

    // Fractions list (for decimals)
    const FRACTIONS=[];
    for(let i=1;i<5;i++) FRACTIONS.push([i,5]);
    for(let i=1;i<6;i++) FRACTIONS.push([i,6]);
    for(let i=1;i<7;i++) FRACTIONS.push([i,7]);
    for(let i=1;i<8;i++) FRACTIONS.push([i,8]);
    [[1,9],[1,11],[1,12],[1,16],[1,32]].forEach(f=>FRACTIONS.push(f));

    /******** Mistake logging ********/
    const MKEY='mistakes_v1';
    const loadMistakes=()=>{ try{ return JSON.parse(localStorage.getItem(MKEY)||'{}'); }catch{ return {}; } };
    const saveMistakes=obj=> localStorage.setItem(MKEY, JSON.stringify(obj));
    function recordAttempt(drill,item,ok){
      const base=item.src || drill;
      const idKey=`${base}|${item.id}`;
      const data=loadMistakes();
      const row=data[idKey] || {text:item.text, drill:base, wrongs:0, attempts:0, lastMiss:0};
      row.attempts++; if(!ok){ row.wrongs++; row.lastMiss=Date.now(); }
      row.text=item.text; data[idKey]=row; saveMistakes(data);
    }
    const clearMistakeStats=()=> localStorage.removeItem(MKEY);

    /******** High scores ********/
    const hiscoreKey=d=>`hiscore_${d}`;
    const getBest=d=> parseInt(localStorage.getItem(hiscoreKey(d))||'0',10);
    const setBest=(d,v)=> localStorage.setItem(hiscoreKey(d), String(v));
    function clearScores(){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith('hiscore_')) localStorage.removeItem(k); }); }

    /******** Banks (finite) ********/
    function buildBank(key){
      const items=[], weights=new Map();
      const add=(id,text,ans,type='int',w=1)=>{ items.push({id,text,ans,type}); weights.set(id,w); };

      // 12√ó table
      if(key==='mult12'){ for(let b=1;b<=15;b++){ const w=(b===1||b===2||b===5||b===10)?0.6:1; add(`12x${b}`,`12 √ó ${b}`,12*b,'int',w);} }

      // 16√ó table (1‚Äì11) ‚Äî NEW
      if(key==='mult16'){ for(let b=1;b<=11;b++){ const w=(b===1||b===2||b===5||b===10)?0.6:1; add(`16x${b}`,`16 √ó ${b}`,16*b,'int',w);} }

      // 12√ó & 16√ó combo ‚Äî NEW
      if(key==='mult1216'){
        const b12=buildBank('mult12');
        const b16=buildBank('mult16');
        for(const it of b12.items){ items.push(it); weights.set(it.id, b12.weights.get(it.id)); }
        for(const it of b16.items){ items.push(it); weights.set(it.id, b16.weights.get(it.id)); }
      }

      // 15√ó table (2‚Äì15)
      if(key==='mult15x'){ for(let b=2;b<=15;b++){ const w=(b===2||b===5||b===10)?0.6:1; add(`15x${b}`,`15 √ó ${b}`,15*b,'int',w);} }

      // Full multiplication banks
      if(key==='mult10' || key==='mult15'){
        const N=(key==='mult10'?10:15);
        for(let a=2;a<=N;a++){ for(let b=2;b<=N;b++){ const w=isSimple(a,b)?SIMPLE_BIAS:1; add(`${a}x${b}`,`${a} √ó ${b}`,a*b,'int',w);} }
      }

      // Division (tables ‚â§20) with scaling (standalone Division drill)
      if(key==='div'){
        for(let d=2; d<=20; d++){
          for(let q=2; q<=20; q++){
            for(let k=0; k<=2; k++){
              const dividend = d*q*Math.pow(10,k);
              const divisor = d;
              const ans = q*Math.pow(10,k);
              const w = (d===2||d===5||d===10)?SIMPLE_BIAS:1;
              add(`d${d}q${q}k${k}`, `${fmt(dividend)} √∑ ${fmt(divisor)}`, ans, 'int', w);
            }
          }
        }
      }

      // Basic division for Mixed (no scaling => no zero-cancel feel)
      if(key==='divBasic'){
        for(let d=2; d<=20; d++){
          for(let q=2; q<=20; q++){
            const dividend = d*q, divisor = d, ans = q;
            const w = (d===2||d===5||d===10)?SIMPLE_BIAS:1;
            add(`db${d}q${q}`, `${fmt(dividend)} √∑ ${fmt(divisor)}`, ans, 'int', w);
          }
        }
      }

      // Zero-canceling division (separate drill)
      if(key==='divZeros'){
        const D = [2,3,4,5,6,8,9,12,15];
        for(const d of D){
          for(let q=2; q<=20; q++){
            for(let k=1; k<=4; k++){
              for(let m=1; m<=k; m++){
                const dividend = d*q*Math.pow(10,k);
                const divisor  = d*Math.pow(10,m);
                const ans = q*Math.pow(10,k-m);
                const w = (d===2||d===5||d===10)?0.7:1;
                add(`dz${d}_${q}_${k}_${m}`, `${fmt(dividend)} √∑ ${fmt(divisor)}`, ans, 'int', w);
              }
            }
          }
        }
      }

      // Other drills
      if(key==='squares'){ for(let n=1;n<=15;n++) add(`sq${n}`,`${n}¬≤`,n*n,'int'); }
      if(key==='cubes'){ for(let n=1;n<=10;n++) add(`cu${n}`,`${n}¬≥`,n*n*n,'int'); }
      if(key==='roots'){ [2,3,5].forEach(r=>add(`r${r}`,`‚àö${r} (3 dp)`,parseFloat(Math.sqrt(r).toFixed(3)),'float')); }
      if(key==='exp2'){ for(let e=1;e<=10;e++) add(`2^${e}`,`2^${e}`,2**e,'int'); }
      if(key==='exp3'){ for(let e=1;e<=5;e++) add(`3^${e}`,`3^${e}`,3**e,'int'); }
      if(key==='exp4'){ for(let e=1;e<=5;e++) add(`4^${e}`,`4^${e}`,4**e,'int'); }
      if(key==='exp5'){ for(let e=1;e<=5;e++) add(`5^${e}`,`5^${e}`,5**e,'int'); }
      if(key==='decimals'){ for(const [n,d] of FRACTIONS) add(`${n}/${d}`,`${n}/${d} (3 dp)`,parseFloat((n/d).toFixed(3)),'float'); }

      return {items, weights};
    }

    // Mixed (no addition; uses divBasic => no scaling, no zero-cancel)
    function buildMixedBank(){
      const keys=[
        'mult12','mult10','mult15', // keep main sets
        'divBasic',                 // only basic division
        'squares','cubes','roots',
        'exp2','exp3','exp4','exp5',
        'decimals'
      ];
      const items=[], weights=new Map();
      for (const k of keys){
        const b=buildBank(k);
        for (const it of b.items){
          const id=`${k}:${it.id}`;
          items.push({id, text:it.text, ans:it.ans, type:it.type, src:k});
          weights.set(id, b.weights.get(it.id));
        }
      }
      return {items,weights};
    }

    function pickWeighted(bank){
      let total=0; for(const id of bank.weights.keys()) total+=bank.weights.get(id);
      let r=Math.random()*total;
      for(const it of bank.items){ r-=bank.weights.get(it.id); if(r<=0) return it; }
      return bank.items[bank.items.length-1];
    }
    const updateWeight=(bank,id,ok)=>{
      const w=bank.weights.get(id) ?? 1;
      bank.weights.set(id, ok ? Math.max(0.25, w-0.2) : Math.min(5, w+1));
    };

    // Two-digit addition (open-set)
    const addBucket=[];
    const pickAdd=()=>{
      if(addBucket.length && Math.random()<0.6){
        const total=addBucket.reduce((s,x)=>s+x.count,0);
        let r=Math.random()*total;
        for(const m of addBucket){ r-=m.count; if(r<=0) return {id:m.key,text:`${m.a} + ${m.b}`,ans:m.a+m.b,type:'int',a:m.a,b:m.b,src:'add2'}; }
      }
      const a=rand(10,99), b=rand(10,99);
      return {id:`${a}+${b}`, text:`${a} + ${b}`, ans:a+b, type:'int', a,b, src:'add2'};
    };
    function recordAddResult(item,ok){
      const i=addBucket.findIndex(x=>x.key===item.id);
      if(ok){ if(i>-1){ addBucket[i].count--; if(addBucket[i].count<=0) addBucket.splice(i,1);} }
      else  { if(i>-1) addBucket[i].count=Math.min(5, addBucket[i].count+1);
              else addBucket.push({key:item.id, a:item.a, b:item.b, count:2}); }
    }

    // Two-digit subtraction (open-set)
    const subBucket=[];
    const pickSub=()=>{
      if(subBucket.length && Math.random()<0.6){
        const total=subBucket.reduce((s,x)=>s+x.count,0);
        let r=Math.random()*total;
        for(const m of subBucket){
          r-=m.count;
          if(r<=0) return {id:m.key, text:`${m.a} ‚àí ${m.b}`, ans:m.a-m.b, type:'int', a:m.a, b:m.b, src:'sub2'};
        }
      }
      let a=rand(10,99), b=rand(10,99);
      if(a<b) [a,b]=[b,a];
      return {id:`${a}-${b}`, text:`${a} ‚àí ${b}`, ans:a-b, type:'int', a,b, src:'sub2'};
    };
    function recordSubResult(item,ok){
      const i=subBucket.findIndex(x=>x.key===item.id);
      if(ok){ if(i>-1){ subBucket[i].count--; if(subBucket[i].count<=0) subBucket.splice(i,1);} }
      else  { if(i>-1) subBucket[i].count=Math.min(5, subBucket[i].count+1);
              else subBucket.push({key:item.id, a:item.a, b:item.b, count:2}); }
    }

    /******** Reference (compact answer sheets) ********/
    const REFERENCEABLE = new Set(['mult12','mult16','mult1216','mult15x','mult10','mult15','squares','cubes','roots','exp2','exp3','exp4','exp5','decimals']);
    const $=id=>document.getElementById(id);
    function hasReference(drill){ return REFERENCEABLE.has(drill); }

    const thRow = labels => `<tr>${labels.map(c=>`<th>${c}</th>`).join('')}</tr>`;
    const tdRow = cells  => `<tr>${cells.map(c=>`<td class="mono">${c}</td>`).join('')}</tr>`;

    function table12(){
      const rows=[thRow(['12 √ó b','Ans'])];
      for(let b=1;b<=15;b++) rows.push(tdRow([`12 √ó ${b}`, 12*b]));
      return `<div class="card"><h4>12√ó</h4><table class="tighttable">${rows.join('')}</table></div>`;
    }
    function table16(){
      const rows=[thRow(['16 √ó b','Ans'])];
      for(let b=1;b<=11;b++) rows.push(tdRow([`16 √ó ${b}`, 16*b]));
      return `<div class="card"><h4>16√ó</h4><table class="tighttable">${rows.join('')}</table></div>`;
    }
    function table15x(){
      const rows=[thRow(['15 √ó b','Ans'])];
      for(let b=2;b<=15;b++) rows.push(tdRow([`15 √ó ${b}`, 15*b]));
      return `<div class="card"><h4>15√ó (2‚Äì15)</h4><table class="tighttable">${rows.join('')}</table></div>`;
    }
    function tableMultMatrix(N){
      const hdr=['√ó', ...Array.from({length:N-1},(_,i)=>i+2)];
      const rows=[thRow(hdr)];
      for(let a=2;a<=N;a++){
        const cells=[a, ...Array.from({length:N-1},(_,j)=> (a*(j+2)))];
        rows.push(tdRow(cells));
      }
      return `<div class="card"><h4>${N===10?'Mult 2‚Äì10':'Mult 2‚Äì15'}</h4><table class="tighttable">${rows.join('')}</table></div>`;
    }
    function tableList(title, pairs){
      const rows=[thRow([title,'Ans'])];
      for(const [label,ans] of pairs) rows.push(tdRow([label, ans]));
      return `<div class="card"><h4>${title}</h4><table class="tighttable">${rows.join('')}</table></div>`;
    }

    function getReferenceHTML(drill){
      // Show everything relevant for the chosen drill, in a compact grid
      if(drill==='mult12')   return `<div class="refgrid">${table12()}</div>`;
      if(drill==='mult16')   return `<div class="refgrid">${table16()}</div>`;
      if(drill==='mult1216') return `<div class="refgrid">${table12()}${table16()}</div>`;
      if(drill==='mult15x')  return `<div class="refgrid">${table15x()}</div>`;
      if(drill==='mult10')   return `<div class="refgrid">${tableMultMatrix(10)}</div>`;
      if(drill==='mult15')   return `<div class="refgrid">${tableMultMatrix(15)}</div>`;
      if(drill==='squares'){
        const pairs = Array.from({length:15},(_,i)=>[`${i+1}¬≤`, (i+1)**2]);
        return `<div class="refgrid">${tableList('Squares 1¬≤‚Äì15¬≤', pairs)}</div>`;
      }
      if(drill==='cubes'){
        const pairs = Array.from({length:10},(_,i)=>[`${i+1}¬≥`, (i+1)**3]);
        return `<div class="refgrid">${tableList('Cubes 1¬≥‚Äì10¬≥', pairs)}</div>`;
      }
      if(drill==='roots'){
        const pairs = [[`‚àö2 (3 dp)`, (Math.sqrt(2)).toFixed(3)],
                       [`‚àö3 (3 dp)`, (Math.sqrt(3)).toFixed(3)],
                       [`‚àö5 (3 dp)`, (Math.sqrt(5)).toFixed(3)]];
        return `<div class="refgrid">${tableList('Roots', pairs)}</div>`;
      }
      if(drill==='exp2'){
        const pairs = Array.from({length:10},(_,e)=>[`2^${e+1}`, 2**(e+1)]);
        return `<div class="refgrid">${tableList('Powers of 2', pairs)}</div>`;
      }
      if(drill==='exp3'){
        const pairs = Array.from({length:5},(_,e)=>[`3^${e+1}`, 3**(e+1)]);
        return `<div class="refgrid">${tableList('Powers of 3', pairs)}</div>`;
      }
      if(drill==='exp4'){
        const pairs = Array.from({length:5},(_,e)=>[`4^${e+1}`, 4**(e+1)]);
        return `<div class="refgrid">${tableList('Powers of 4', pairs)}</div>`;
      }
      if(drill==='exp5'){
        const pairs = Array.from({length:5},(_,e)=>[`5^${e+1}`, 5**(e+1)]);
        return `<div class="refgrid">${tableList('Powers of 5', pairs)}</div>`;
      }
      if(drill==='decimals'){
        const pairs = [];
        for(let i=1;i<5;i++) pairs.push([`${i}/5 (3 dp)`, (i/5).toFixed(3)]);
        for(let i=1;i<6;i++) pairs.push([`${i}/6 (3 dp)`, (i/6).toFixed(3)]);
        for(let i=1;i<7;i++) pairs.push([`${i}/7 (3 dp)`, (i/7).toFixed(3)]);
        for(let i=1;i<8;i++) pairs.push([`${i}/8 (3 dp)`, (i/8).toFixed(3)]);
        [[1,9],[1,11],[1,12],[1,16],[1,32]].forEach(([n,d])=>pairs.push([`${n}/${d} (3 dp)`, (n/d).toFixed(3)]));
        return `<div class="refgrid">${tableList('Fractions ‚Üí decimals', pairs)}</div>`;
      }
      return `<div class="card">No reference available.</div>`;
    }

    /******** UI wiring ********/
    const menu=$('menu'), quiz=$('quiz'), settings=$('settings');
    const hud=$('hud'), hudDrill=$('hudDrill'), hudTimer=$('hudTimer'), tLeftEl=$('tLeft'),
          hudScore=$('hudScore'), scoreEl=$('score'), hudBest=$('hudBest'), bestEl=$('best'),
          bestBadge=$('bestBadge'), bestMenu=$('bestMenu');
    const qEl=$('question'), aEl=$('answer'), fb=$('feedback'), endpanel=$('endpanel'), back=$('back');
    const submitBtn=$('submitBtn');
    const openSettingsBtn=$('openSettings'), closeSettingsBtn=$('closeSettings'),
          clearStatsBtn=$('clearStats'), clearScoresBtn=$('clearScores'),
          fltDrill=$('fltDrill'), fltSort=$('fltSort'), statsContainer=$('statsContainer');
    const refBtn=$('refBtn'), refModal=$('refModal'), refCloseBtn=$('refCloseBtn'), refCloseBg=$('refCloseBg'), refTitle=$('refTitle'), refContent=$('refContent');

    const radios=[...document.querySelectorAll("input[name='mode']")];
    const getMode=()=> radios.find(r=>r.checked)?.value || 'practice';

    let drill=null, bank=null, current=null, awaiting=false, isSprint=false;
    let timeLeft=SPRINT_SECONDS, tick=null, score=0, lastHoverDrill=null;

    function refreshMenuBestFor(d){
      if(getMode()==='sprint' && d){ bestBadge.hidden=false; bestMenu.textContent=getBest(d); }
      else bestBadge.hidden=true;
    }
    radios.forEach(r=>r.addEventListener('change',()=>refreshMenuBestFor(lastHoverDrill)));

    document.querySelectorAll('#menu [data-drill]').forEach(btn=>{
      btn.addEventListener('mouseenter',()=>{ lastHoverDrill=btn.dataset.drill; refreshMenuBestFor(lastHoverDrill); });
      btn.addEventListener('focus',()=>{ lastHoverDrill=btn.dataset.drill; refreshMenuBestFor(lastHoverDrill); });
      btn.addEventListener('click',()=>start(btn.dataset.drill));
    });

    openSettingsBtn.addEventListener('click',()=>{ menu.hidden=true; quiz.hidden=true; settings.hidden=false; renderStats(); });
    closeSettingsBtn.addEventListener('click',()=>{ settings.hidden=true; menu.hidden=false; });
    clearStatsBtn.addEventListener('click',()=>{ clearMistakeStats(); renderStats(); });
    clearScoresBtn.addEventListener('click',()=>{ clearScores(); renderStats(); refreshMenuBestFor(lastHoverDrill); });
    fltDrill.addEventListener('change',renderStats);
    fltSort.addEventListener('change',renderStats);

    function start(sel){
      drill=sel; isSprint=(getMode()==='sprint');
      if(drill==='add2' || drill==='sub2') bank=null;
      else if(drill==='mixed') bank=buildMixedBank();
      else bank=buildBank(drill);

      menu.hidden=true; settings.hidden=true; quiz.hidden=false; endpanel.innerHTML='';
      fb.textContent=''; fb.className=''; hud.hidden=false; hudDrill.textContent=labelFor(drill);

      // Reference button visibility
      refBtn.hidden=!hasReference(drill);

      if(isSprint){
        score=0; scoreEl.textContent='0';
        hudTimer.hidden=false; hudScore.hidden=false; hudBest.hidden=false;
        timeLeft=SPRINT_SECONDS; tLeftEl.textContent=String(timeLeft);
        bestEl.textContent=String(getBest(drill));
        if(tick) clearInterval(tick);
        tick=setInterval(()=>{ timeLeft--; tLeftEl.textContent=String(timeLeft); if(timeLeft<=0){ finishSprint(); }},1000);
      }else{
        hudTimer.hidden=true; hudScore.hidden=true; hudBest.hidden=true;
        if(tick){ clearInterval(tick); tick=null; }
      }
      ask();
    }

    function labelFor(k){
      const map={
        mixed:'Mixed (no addition; no zero-cancel)',
        mult12:'12 √ó (1‚Äì15)', mult16:'16 √ó (1‚Äì11)', mult1216:'12√ó & 16√ó',
        mult15x:'15 √ó (2‚Äì15)',
        mult10:'Mult 1‚Äì10', mult15:'Mult 1‚Äì15',
        div:'Division (‚â§20 tables)', divZeros:'Division (zero-canceling)',
        add2:'Two-digit addition', sub2:'Two-digit subtraction',
        squares:'Perfect squares', cubes:'Perfect cubes',
        roots:'Roots (‚àö2,‚àö3,‚àö5)', exp2:'Powers of 2', exp3:'Powers of 3', exp4:'Powers of 4',
        exp5:'Powers of 5', decimals:'Fractions ‚Üí decimals'
      };
      return map[k]||k;
    }

    function pickQuestion(){
      if(drill==='add2') return pickAdd();
      if(drill==='sub2') return pickSub();
      return pickWeighted(bank);
    }

    function ask(){
      awaiting=false;
      current=pickQuestion();
      qEl.textContent=current.text;
      aEl.disabled=false; aEl.value=''; aEl.focus({preventScroll:true});
      fb.textContent=''; fb.className='';
    }

    function check(){
      if(awaiting) return;
      const raw=aEl.value.trim(); if(!raw) return;
      let ok=false;

      if(current.type==='float'){
        const user=parseFloat(raw.replace(/,/g,''));
        if(!Number.isNaN(user) && Math.abs(user-current.ans)<0.01) ok=true;
      }else{
        const user=parseIntClean(raw);
        if(!Number.isNaN(user) && user===current.ans) ok=true;
      }

      recordAttempt(drill,current,ok);
      if(drill==='add2') recordAddResult(current,ok);
      else if(drill==='sub2') recordSubResult(current,ok);
      else updateWeight(bank,current.id,ok);

      if(isSprint){
        if(ok){ score++; scoreEl.textContent=String(score); }
        ask(); // no delay
        return;
      }

      fb.textContent = ok ? '‚úÖ Correct!' : `‚ùå (${current.type==='float'?current.ans.toFixed(3):fmt(current.ans)})`;
      fb.className = ok ? 'correct' : 'wrong';
      aEl.disabled=true; awaiting=true;
      setTimeout(()=>{ awaiting=false; ask(); }, ok?650:1100);
    }

    function finishSprint(){
      if(tick){ clearInterval(tick); tick=null; }
      aEl.disabled=true;
      const prev=getBest(drill);
      if(score>prev) setBest(drill,score);
      bestEl.textContent=String(getBest(drill));
      endpanel.innerHTML = `
        <div class="row" style="flex-wrap:wrap; justify-content:center">
          <span class="badge">Time! Score: <b>${score}</b> ‚Äî Best: <b>${getBest(drill)}</b>${score>prev?' üéâ':''}</span>
          <button class="pill" id="again">Play Again</button>
        </div>`;
      document.getElementById('again').addEventListener('click',()=>start(drill));
    }

    aEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); if(isSprint && timeLeft<=0) return; check(); } });
    submitBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(isSprint && timeLeft<=0) return; check(); });

    back.addEventListener('click', ()=>{
      if(tick){ clearInterval(tick); tick=null; }
      quiz.hidden=true; menu.hidden=false; hud.hidden=true;
      aEl.value=''; fb.textContent=''; fb.className=''; endpanel.innerHTML='';
      refreshMenuBestFor(drill);
      drill=null; bank=null; current=null; score=0;
    });

    /******** Reference UI handlers ********/
    function openReference(){
      refTitle.textContent = `Reference ‚Äî ${labelFor(drill)}`;
      refContent.innerHTML = getReferenceHTML(drill);
      refModal.hidden=false;
    }
    function closeReference(){ refModal.hidden=true; aEl.focus({preventScroll:true}); }

    refBtn.addEventListener('click', openReference);
    refCloseBtn.addEventListener('click', closeReference);
    refCloseBg.addEventListener('click', closeReference);
    document.addEventListener('keydown', (e)=>{ if(!refModal.hidden && e.key==='Escape') closeReference(); });

    /******** Settings render ********/
    function fmtAgo(ts){
      if(!ts) return '‚Äî';
      const s=Math.floor((Date.now()-ts)/1000);
      if(s<60) return s+'s ago';
      const m=Math.floor(s/60); if(m<60) return m+'m ago';
      const h=Math.floor(m/60); if(h<24) return h+'h ago';
      const d=Math.floor(h/24); return d+'d ago';
    }
    function renderStats(){
      const data=loadMistakes();
      const rows=Object.entries(data).map(([key,val])=>({key, ...val}));
      const flt=fltDrill.value;
      let lst = rows.filter(r=> !flt || r.drill===flt);

      const sort=fltSort.value;
      lst.sort((a,b)=>{
        if(sort==='wrongs') return (b.wrongs||0)-(a.wrongs||0);
        if(sort==='rate'){
          const ar = a.attempts? a.wrongs/a.attempts : 0;
          const br = b.attempts? b.wrongs/b.attempts : 0;
          return br - ar;
        }
        if(sort==='recent') return (b.lastMiss||0)-(a.lastMiss||0);
        if(sort==='attempts') return (b.attempts||0)-(a.attempts||0);
        return 0;
      });

      const top = lst.slice(0,50);
      const table = `
        <table>
          <thead>
            <tr>
              <th>Drill</th>
              <th>Question</th>
              <th class="right">Wrongs</th>
              <th class="right">Attempts</th>
              <th class="right">Accuracy</th>
              <th class="right">Last miss</th>
            </tr>
          </thead>
          <tbody>
            ${top.map(r=>`
              <tr>
                <td><span class="drilltag">${r.drill}</span></td>
                <td class="mono">${r.text}</td>
                <td class="right mono">${r.wrongs||0}</td>
                <td class="right mono">${r.attempts||0}</td>
                <td class="right mono">${r.attempts? (100 - Math.round((r.wrongs/r.attempts)*100))+'%' : '‚Äî'}</td>
                <td class="right small">${fmtAgo(r.lastMiss||0)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="small" style="margin-top:.4rem;">Showing top ${top.length} items</div>
      `;
      statsContainer.innerHTML = table;

      const drills=['mixed','mult12','mult16','mult1216','mult15x','mult10','mult15','div','divZeros','add2','sub2','squares','cubes','roots','exp2','exp3','exp4','exp5','decimals'];
      const bests = drills.map(d=>`${d}: ${getBest(d)}`).join('  ¬∑  ');
      const bestDiv = document.createElement('div');
      bestDiv.className='small'; bestDiv.style.marginTop='.6rem';
      bestDiv.textContent = `High scores ‚Äî ${bests}`;
      statsContainer.appendChild(bestDiv);
    }
  </script>
</body>
</html>
