<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Drills — Dark + Stats + Division + Add/Sub</title>
  <style>
    :root{
      --bg:#0b1220; --surface:#111a2b; --muted:#1a2440;
      --text:#e5e7eb; --subtle:#aeb6c2;
      --blue:#3b82f6; --blue-d:#2563eb;
      --good:#16a34a; --bad:#ef4444;
      --shadow:0 10px 28px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
         background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; gap:16px;}
    h1{margin:0 0 4px; font-size:1.6rem; letter-spacing:.2px}
    .sub{color:var(--subtle); font-size:.95rem}

    .topbar{width:100%; max-width:1000px; display:flex; justify-content:space-between; align-items:center}
    .ghost{background:transparent; color:var(--text); border:1px solid var(--muted);
           padding:.5rem .8rem; border-radius:999px; cursor:pointer;}
    .ghost:hover{background:var(--muted)}

    .panel{width:100%; max-width:1000px; background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    #menu h2,#settings h2{margin:0 0 .6rem}
    .mode-row{display:flex; gap:12px; align-items:center; margin:.25rem 0 .75rem}
    .badge{background:var(--muted); color:var(--text); border-radius:999px; padding:.25rem .6rem; font-size:.9rem}

    .grid{display:grid; gap:.6rem; grid-template-columns:repeat(auto-fit, minmax(220px,1fr));}
    .grid button,#back,.pill,.danger{
      border:0; border-radius:12px; padding:.7rem 1rem; cursor:pointer; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .grid button,#back,.pill{ background:var(--blue); color:#fff; }
    .grid button:hover,#back:hover,.pill:hover{ background:var(--blue-d); }
    .danger{ background:#b91c1c; color:#fff } .danger:hover{ background:#991b1b }

    #quiz{max-width:720px; margin-inline:auto;}
    #hud{display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; margin:.25rem 0 .5rem}
    .pill{background:#0f1a30}
    #question{background:var(--muted); border-radius:var(--radius); padding:14px; font-size:1.9rem; text-align:center; margin:.6rem 0;}
    #answer{width:260px; padding:.6rem .75rem; font-size:1.2rem; text-align:center; border:2px solid #2a3558; border-radius:12px; background:#0e1730; color:var(--text); box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);}
    #answer:disabled{opacity:.7}
    #feedback{min-height:1.4rem; margin:.5rem 0 0; font-size:1.1rem}
    .correct{color:var(--good)} .wrong{color:var(--bad)}
    .row{display:flex; gap:.6rem; justify-content:center; margin-top:.8rem}
    .visually-hidden{position:absolute; left:-9999px}

    #settings .controls{display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin:.5rem 0 .75rem}
    select{background:#0e1730; color:var(--text); border:1px solid #2a3558; border-radius:10px; padding:.4rem .6rem;}
    table{width:100%; border-collapse:collapse; margin-top:.5rem; font-size:.95rem}
    th,td{padding:.55rem .6rem; text-align:left; border-bottom:1px solid #1e2a4a}
    th{color:#b9c2d0; font-weight:600}
    tbody tr:hover{background:#0f1934}
    .mono{font-variant-numeric:tabular-nums}
    .small{font-size:.85rem; color:#c7ceda}
    .right{text-align:right}
    .drilltag{background:#0f1a30; padding:.15rem .5rem; border-radius:999px; font-size:.8rem}
  </style>
</head>
<body>
  <div class="topbar panel" style="display:flex; gap:12px; align-items:center;">
    <div>
      <h1>Math Drills</h1>
      <div class="sub">Dark mode • adaptive practice • sprint • stats</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <button id="openSettings" class="ghost">⚙️ Settings & Stats</button>
    </div>
  </div>

  <!-- MENU -->
  <div id="menu" class="panel">
    <h2>Choose a drill</h2>
    <div class="mode-row">
      <label><input type="radio" name="mode" value="practice" checked> Practice</label>
      <label><input type="radio" name="mode" value="sprint"> 1-min Sprint</label>
      <span id="bestBadge" class="badge" hidden>Best: <b id="bestMenu">0</b></span>
    </div>
    <div class="grid">
      <button data-drill="mixed">Mixed (no addition)</button>
      <button data-drill="mult12">12 × (1–15)</button>
      <button data-drill="mult10">Multiplication 1–10 (no ×1, downweight easy)</button>
      <button data-drill="mult15">Multiplication 1–15 (no ×1, downweight easy)</button>
      <button data-drill="div">Division (tables ≤20)</button>
      <button data-drill="divZeros">Division (zero-canceling)</button>
      <button data-drill="addAll">Additions (2- & 3-digit)</button>
      <button data-drill="subAll">Subtractions (2- & 3-digit)</button>
      <button data-drill="squares">Perfect squares (1²–15²)</button>
      <button data-drill="cubes">Perfect cubes (1³–10³)</button>
      <button data-drill="roots">√2, √3, √5 (3 decimals)</button>
      <button data-drill="exp2">Powers of 2 (1–10)</button>
      <button data-drill="exp3">Powers of 3 (1–5)</button>
      <button data-drill="exp4">Powers of 4 (1–5)</button>
      <button data-drill="exp5">Powers of 5 (1–5)</button>
      <button data-drill="decimals">Fractions → decimals</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="panel" hidden>
    <div id="hud" hidden>
      <span id="hudDrill" class="pill">—</span>
      <span id="hudTimer" class="pill" hidden>⏱️ <b id="tLeft">60</b>s</span>
      <span id="hudScore" class="pill" hidden>Score: <b id="score">0</b></span>
      <span id="hudBest" class="pill" hidden>Best: <b id="best">0</b></span>
    </div>

    <div id="question"></div>
    <label for="answer" class="visually-hidden">Answer</label>
    <div style="display:flex; justify-content:center;">
      <input id="answer" type="text" inputmode="decimal" autocomplete="off"/>
    </div>
    <div id="feedback" aria-live="polite"></div>
    <div id="endpanel"></div>

    <div class="row">
      <button id="back">Back</button>
    </div>
  </div>

  <!-- SETTINGS / STATS -->
  <div id="settings" class="panel" hidden>
    <h2>Settings & Stats</h2>
    <div class="controls">
      <label>Filter drill:
        <select id="fltDrill">
          <option value="">All</option>
          <option value="mixed">Mixed</option>
          <option value="mult12">12 ×</option>
          <option value="mult10">Mult 1–10</option>
          <option value="mult15">Mult 1–15</option>
          <option value="div">Division</option>
          <option value="divZeros">Division (zero-cancel)</option>
          <option value="addAll">Additions (2&3)</option>
          <option value="subAll">Subtractions (2&3)</option>
          <option value="squares">Squares</option>
          <option value="cubes">Cubes</option>
          <option value="roots">Roots</option>
          <option value="exp2">2^</option>
          <option value="exp3">3^</option>
          <option value="exp4">4^</option>
          <option value="exp5">5^</option>
          <option value="decimals">Decimals</option>
          <!-- legacy filter so old data still viewable -->
          <option value="add2">Addition (legacy)</option>
        </select>
      </label>
      <label>Sort by:
        <select id="fltSort">
          <option value="wrongs">Most wrongs</option>
          <option value="rate">Lowest accuracy</option>
          <option value="recent">Most recent miss</option>
          <option value="attempts">Most attempts</option>
        </select>
      </label>
      <button id="clearStats" class="danger">Clear mistake stats</button>
      <button id="clearScores" class="ghost">Clear high scores</button>
      <button id="closeSettings" class="ghost" style="margin-left:auto">Back to menu</button>
    </div>
    <div id="statsContainer"></div>
  </div>

  <script>
    /******** Helpers & constants ********/
    const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const SPRINT_SECONDS=60;
    const SIMPLE_BIAS=0.35; // lower => rarer easy facts (mult/div)
    const isSimple=(a,b)=> (a<=3||b<=3||a===5||b===5||a===10||b===10);
    const fmt=n=> n.toLocaleString('en-CA');
    const parseIntClean = s => {
      const cleaned = s.replace(/,/g,'').trim();
      const v = parseInt(cleaned,10);
      return Number.isNaN(v) ? NaN : v;
    };

    // Fractions list (for decimals)
    const FRACTIONS=[];
    for(let i=1;i<5;i++) FRACTIONS.push([i,5]);
    for(let i=1;i<6;i++) FRACTIONS.push([i,6]);
    for(let i=1;i<7;i++) FRACTIONS.push([i,7]);
    for(let i=1;i<8;i++) FRACTIONS.push([i,8]);
    [[1,9],[1,11],[1,12],[1,16],[1,32]].forEach(f=>FRACTIONS.push(f));

    /******** Mistake logging ********/
    const MKEY='mistakes_v1';
    const loadMistakes=()=>{ try{ return JSON.parse(localStorage.getItem(MKEY)||'{}'); }catch{ return {}; } };
    const saveMistakes=obj=> localStorage.setItem(MKEY, JSON.stringify(obj));
    function recordAttempt(drill,item,ok){
      const base=item.src || drill;
      const idKey=`${base}|${item.id}`;
      const data=loadMistakes();
      const row=data[idKey] || {text:item.text, drill:base, wrongs:0, attempts:0, lastMiss:0};
      row.attempts++; if(!ok){ row.wrongs++; row.lastMiss=Date.now(); }
      row.text=item.text; data[idKey]=row; saveMistakes(data);
    }
    const clearMistakeStats=()=> localStorage.removeItem(MKEY);

    /******** High scores ********/
    const hiscoreKey=d=>`hiscore_${d}`;
    const getBest=d=> parseInt(localStorage.getItem(hiscoreKey(d))||'0',10);
    const setBest=(d,v)=> localStorage.setItem(hiscoreKey(d), String(v));
    function clearScores(){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith('hiscore_')) localStorage.removeItem(k); }); }

    /******** Banks (finite) ********/
    function buildBank(key){
      const items=[], weights=new Map();
      const add=(id,text,ans,type='int',w=1)=>{ items.push({id,text,ans,type}); weights.set(id,w); };

      // Multiplication
      if(key==='mult12'){ for(let b=1;b<=15;b++){ const w=(b===1||b===2||b===5||b===10)?0.6:1; add(`12x${b}`,`12 × ${b}`,12*b,'int',w);} }
      if(key==='mult10' || key==='mult15'){
        const N=(key==='mult10'?10:15);
        for(let a=2;a<=N;a++){ for(let b=2;b<=N;b++){ const w=isSimple(a,b)?SIMPLE_BIAS:1; add(`${a}x${b}`,`${a} × ${b}`,a*b,'int',w);} }
      }

      // Division (tables ≤20) — scaled by 10^k for e.g. 510 ÷ 3
      if(key==='div'){
        for(let d=2; d<=20; d++){
          for(let q=2; q<=20; q++){
            for(let k=0; k<=2; k++){
              const dividend = d*q*Math.pow(10,k);
              const divisor = d;
              const ans = q*Math.pow(10,k);
              const w = (d===2||d===5||d===10)?SIMPLE_BIAS:1;
              add(`d${d}q${q}k${k}`, `${fmt(dividend)} ÷ ${fmt(divisor)}`, ans, 'int', w);
            }
          }
        }
      }

      // Division (zero-canceling)
      if(key==='divZeros'){
        const D = [2,3,4,5,6,8,9,12,15];
        for(const d of D){
          for(let q=2; q<=20; q++){
            for(let k=1; k<=4; k++){
              for(let m=1; m<=k; m++){
                const dividend = d*q*Math.pow(10,k);
                const divisor  = d*Math.pow(10,m);
                const ans = q*Math.pow(10,k-m);
                const w = (d===2||d===5||d===10)?0.7:1;
                add(`dz${d}_${q}_${k}_${m}`, `${fmt(dividend)} ÷ ${fmt(divisor)}`, ans, 'int', w);
              }
            }
          }
        }
      }

      // Squares/Cubes/Roots/Exponents/Decimals
      if(key==='squares'){ for(let n=1;n<=15;n++) add(`sq${n}`,`${n}²`,n*n,'int'); }
      if(key==='cubes'){ for(let n=1;n<=10;n++) add(`cu${n}`,`${n}³`,n*n*n,'int'); }
      if(key==='roots'){ [2,3,5].forEach(r=>add(`r${r}`,`√${r} (3 dp)`,parseFloat(Math.sqrt(r).toFixed(3)),'float')); }
      if(key==='exp2'){ for(let e=1;e<=10;e++) add(`2^${e}`,`2^${e}`,2**e,'int'); }
      if(key==='exp3'){ for(let e=1;e<=5;e++) add(`3^${e}`,`3^${e}`,3**e,'int'); }
      if(key==='exp4'){ for(let e=1;e<=5;e++) add(`4^${e}`,`4^${e}`,4**e,'int'); }
      if(key==='exp5'){ for(let e=1;e<=5;e++) add(`5^${e}`,`5^${e}`,5**e,'int'); }
      if(key==='decimals'){ for(const [n,d] of FRACTIONS) add(`${n}/${d}`,`${n}/${d} (3 dp)`,parseFloat((n/d).toFixed(3)),'float'); }

      return {items, weights};
    }

    // Mixed (no addition)
    function buildMixedBank(){
      const keys=['mult12','mult10','mult15','div','divZeros','squares','cubes','roots','exp2','exp3','exp4','exp5','decimals'];
      const items=[], weights=new Map();
      for(const k of keys){
        const b=buildBank(k);
        for(const it of b.items){
          const id=`${k}:${it.id}`;
          items.push({id, text:it.text, ans:it.ans, type:it.type, src:k});
          weights.set(id, b.weights.get(it.id));
        }
      }
      return {items,weights};
    }

    function pickWeighted(bank){
      let total=0; for(const id of bank.weights.keys()) total+=bank.weights.get(id);
      let r=Math.random()*total;
      for(const it of bank.items){ r-=bank.weights.get(it.id); if(r<=0) return it; }
      return bank.items[bank.items.length-1];
    }
    const updateWeight=(bank,id,ok)=>{
      const w=bank.weights.get(id) ?? 1;
      bank.weights.set(id, ok ? Math.max(0.25, w-0.2) : Math.min(5, w+1));
    };

    /******** Open-set generators (Additions/Subtractions + legacy add2) ********/
    // Use “mistake buckets” so recent misses reappear more often.
    const addBucket=[];      // additions: {key,a,b,count,src}
    const subBucket=[];      // subtractions

    function pickAddAll(){
      // 50/50 pick 2-digit or 3-digit
      const three = Math.random()<0.5;
      const a = three ? rand(100,999) : rand(10,99);
      const b = three ? rand(100,999) : rand(10,99);
      // 60% chance to pull from bucket if available
      if(addBucket.length && Math.random()<0.6){
        const total=addBucket.reduce((s,x)=>s+x.count,0);
        let r=Math.random()*total;
        for(const m of addBucket){ r-=m.count; if(r<=0) return {id:m.key,text:`${fmt(m.a)} + ${fmt(m.b)}`,ans:m.a+m.b,type:'int',a:m.a,b:m.b,src:'addAll'}; }
      }
      return {id:`add${a}+${b}`, text:`${fmt(a)} + ${fmt(b)}`, ans:a+b, type:'int', a,b, src:'addAll'};
    }
    function recordAddAll(item,ok){
      const idx=addBucket.findIndex(x=>x.key===item.id);
      if(ok){ if(idx>-1){ addBucket[idx].count--; if(addBucket[idx].count<=0) addBucket.splice(idx,1); } }
      else{
        if(idx>-1) addBucket[idx].count = Math.min(5, addBucket[idx].count+1);
        else addBucket.push({key:item.id,a:item.a,b:item.b,count:2,src:'addAll'});
      }
    }

    function pickSubAll(){
      const three = Math.random()<0.5;
      let a = three ? rand(100,999) : rand(10,99);
      let b = three ? rand(100,999) : rand(10,99);
      if(a<b) [a,b]=[b,a]; // ensure non-negative
      if(subBucket.length && Math.random()<0.6){
        const total=subBucket.reduce((s,x)=>s+x.count,0);
        let r=Math.random()*total;
        for(const m of subBucket){ r-=m.count; if(r<=0) return {id:m.key,text:`${fmt(m.a)} − ${fmt(m.b)}`,ans:m.a-m.b,type:'int',a:m.a,b:m.b,src:'subAll'}; }
      }
      return {id:`sub${a}-${b}`, text:`${fmt(a)} − ${fmt(b)}`, ans:a-b, type:'int', a,b, src:'subAll'};
    }
    function recordSubAll(item,ok){
      const idx=subBucket.findIndex(x=>x.key===item.id);
      if(ok){ if(idx>-1){ subBucket[idx].count--; if(subBucket[idx].count<=0) subBucket.splice(idx,1); } }
      else{
        if(idx>-1) subBucket[idx].count = Math.min(5, subBucket[idx].count+1);
        else subBucket.push({key:item.id,a:item.a,b:item.b,count:2,src:'subAll'});
      }
    }

    // Legacy two-digit addition (still supported in stats; no menu button)
    function pickAdd2Legacy(){
      const a=rand(10,99), b=rand(10,99);
      return {id:`${a}+${b}`, text:`${a} + ${b}`, ans:a+b, type:'int', a,b, src:'add2'};
    }
    function recordAdd2Legacy(item,ok){
      // share the same bucket behavior if ever used (not on menu)
      recordAddAll({...item,src:'addAll'},ok);
    }

    /******** UI wiring ********/
    const $=id=>document.getElementById(id);
    const menu=$('menu'), quiz=$('quiz'), settings=$('settings');
    const hud=$('hud'), hudDrill=$('hudDrill'), hudTimer=$('hudTimer'), tLeftEl=$('tLeft'),
          hudScore=$('hudScore'), scoreEl=$('score'), hudBest=$('hudBest'), bestEl=$('best'),
          bestBadge=$('bestBadge'), bestMenu=$('bestMenu');
    const qEl=$('question'), aEl=$('answer'), fb=$('feedback'), endpanel=$('endpanel'), back=$('back');
    const openSettingsBtn=$('openSettings'), closeSettingsBtn=$('closeSettings'),
          clearStatsBtn=$('clearStats'), clearScoresBtn=$('clearScores'),
          fltDrill=$('fltDrill'), fltSort=$('fltSort'), statsContainer=$('statsContainer');

    const radios=[...document.querySelectorAll("input[name='mode']")];
    const getMode=()=> radios.find(r=>r.checked)?.value || 'practice';

    let drill=null, bank=null, current=null, awaiting=false, isSprint=false;
    let timeLeft=SPRINT_SECONDS, tick=null, score=0, lastHoverDrill=null;

    function refreshMenuBestFor(d){
      if(getMode()==='sprint' && d){ bestBadge.hidden=false; bestMenu.textContent=getBest(d); }
      else bestBadge.hidden=true;
    }
    radios.forEach(r=>r.addEventListener('change',()=>refreshMenuBestFor(lastHoverDrill)));

    document.querySelectorAll('#menu [data-drill]').forEach(btn=>{
      btn.addEventListener('mouseenter',()=>{ lastHoverDrill=btn.dataset.drill; refreshMenuBestFor(lastHoverDrill); });
      btn.addEventListener('focus',()=>{ lastHoverDrill=btn.dataset.drill; refreshMenuBestFor(lastHoverDrill); });
      btn.addEventListener('click',()=>start(btn.dataset.drill));
    });

    openSettingsBtn.addEventListener('click',()=>{ menu.hidden=true; quiz.hidden=true; settings.hidden=false; renderStats(); });
    closeSettingsBtn.addEventListener('click',()=>{ settings.hidden=true; menu.hidden=false; });
    clearStatsBtn.addEventListener('click',()=>{ clearMistakeStats(); renderStats(); });
    clearScoresBtn.addEventListener('click',()=>{ clearScores(); renderStats(); refreshMenuBestFor(lastHoverDrill); });
    fltDrill.addEventListener('change',renderStats);
    fltSort.addEventListener('change',renderStats);

    function start(sel){
      drill=sel; isSprint=(getMode()==='sprint');

      // choose generator or bank
      if(drill==='addAll' || drill==='subAll'){ bank=null; }
      else if(drill==='mixed'){ bank=buildMixedBank(); }
      else { bank=buildBank(drill); }

      menu.hidden=true; settings.hidden=true; quiz.hidden=false; endpanel.innerHTML='';
      fb.textContent=''; fb.className=''; hud.hidden=false; hudDrill.textContent=labelFor(drill);

      if(isSprint){
        score=0; scoreEl.textContent='0';
        hudTimer.hidden=false; hudScore.hidden=false; hudBest.hidden=false;
        timeLeft=SPRINT_SECONDS; tLeftEl.textContent=String(timeLeft);
        bestEl.textContent=String(getBest(drill));
        if(tick) clearInterval(tick);
        tick=setInterval(()=>{ timeLeft--; tLeftEl.textContent=String(timeLeft); if(timeLeft<=0){ finishSprint(); }},1000);
      }else{
        hudTimer.hidden=true; hudScore.hidden=true; hudBest.hidden=true;
        if(tick){ clearInterval(tick); tick=null; }
      }
      ask();
    }

    function labelFor(k){
      const map={ mixed:'Mixed (no addition)', mult12:'12 × (1–15)', mult10:'Mult 1–10',
        mult15:'Mult 1–15', div:'Division (≤20 tables)', divZeros:'Division (zero-canceling)',
        addAll:'Additions (2 & 3 digits)', subAll:'Subtractions (2 & 3 digits)',
        squares:'Perfect squares', cubes:'Perfect cubes',
        roots:'Roots (√2,√3,√5)', exp2:'Powers of 2', exp3:'Powers of 3', exp4:'Powers of 4',
        exp5:'Powers of 5', decimals:'Fractions → decimals', add2:'Addition (legacy)' };
      return map[k]||k;
    }

    function pickQuestion(){
      if(drill==='addAll') return pickAddAll();
      if(drill==='subAll') return pickSubAll();
      // legacy hook (not reachable from menu)
      if(drill==='add2') return pickAdd2Legacy();
      return pickWeighted(bank); // finite sets
    }

    function ask(){
      awaiting=false;
      current=pickQuestion();
      qEl.textContent=current.text;
      aEl.disabled=false; aEl.value=''; aEl.focus();
      fb.textContent=''; fb.className='';
    }

    function check(){
      if(awaiting) return;
      const raw=aEl.value.trim(); if(!raw) return;
      let ok=false;

      if(current.type==='float'){
        const user=parseFloat(raw.replace(/,/g,'')); // accept commas
        if(!Number.isNaN(user) && Math.abs(user-current.ans)<0.01) ok=true;
      }else{
        const user=parseIntClean(raw);
        if(!Number.isNaN(user) && user===current.ans) ok=true;
      }

      // log + adapt
      recordAttempt(drill,current,ok);
      if(drill==='addAll') recordAddAll(current,ok);
      else if(drill==='subAll') recordSubAll(current,ok);
      else if(drill==='add2') recordAdd2Legacy(current,ok);
      else updateWeight(bank,current.id,ok);

      if(isSprint){
        if(ok){ score++; scoreEl.textContent=String(score); }
        ask(); // no delay
        return;
      }

      // Practice: brief feedback then advance
      fb.textContent = ok ? '✅ Correct!' : `❌ (${current.type==='float'?current.ans.toFixed(3):fmt(current.ans)})`;
      fb.className = ok ? 'correct' : 'wrong';
      aEl.disabled=true; awaiting=true;
      setTimeout(()=>{ awaiting=false; ask(); }, ok?650:1100);
    }

    function finishSprint(){
      if(tick){ clearInterval(tick); tick=null; }
      aEl.disabled=true;
      const prev=getBest(drill);
      if(score>prev) setBest(drill,score);
      bestEl.textContent=String(getBest(drill));
      endpanel.innerHTML = `
        <div class="row" style="flex-wrap:wrap; justify-content:center">
          <span class="badge">Time! Score: <b>${score}</b> — Best: <b>${getBest(drill)}</b>${score>prev?' 🎉':''}</span>
          <button class="pill" id="again">Play Again</button>
        </div>`;
      document.getElementById('again').addEventListener('click',()=>start(drill));
    }

    aEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); if(isSprint && timeLeft<=0) return; check(); } });
    const radios=[...document.querySelectorAll("input[name='mode']")];
    back.addEventListener('click', ()=>{
      if(tick){ clearInterval(tick); tick=null; }
      quiz.hidden=true; menu.hidden=false; hud.hidden=true;
      aEl.value=''; fb.textContent=''; fb.className=''; endpanel.innerHTML='';
      refreshMenuBestFor(drill);
      drill=null; bank=null; current=null; score=0;
    });

    /******** Settings render ********/
    function fmtAgo(ts){
      if(!ts) return '—';
      const s=Math.floor((Date.now()-ts)/1000);
      if(s<60) return s+'s ago';
      const m=Math.floor(s/60); if(m<60) return m+'m ago';
      const h=Math.floor(m/60); if(h<24) return h+'h ago';
      const d=Math.floor(h/24); return d+'d ago';
    }
    function renderStats(){
      const data=loadMistakes();
      const rows=Object.entries(data).map(([key,val])=>({key, ...val}));
      const flt=fltDrill.value;
      let lst = rows.filter(r=> !flt || r.drill===flt);

      const sort=fltSort.value;
      lst.sort((a,b)=>{
        if(sort==='wrongs') return (b.wrongs||0)-(a.wrongs||0);
        if(sort==='rate'){
          const ar = a.attempts? a.wrongs/a.attempts : 0;
          const br = b.attempts? b.wrongs/b.attempts : 0;
          return br - ar; // lowest accuracy first
        }
        if(sort==='recent') return (b.lastMiss||0)-(a.lastMiss||0);
        if(sort==='attempts') return (b.attempts||0)-(a.attempts||0);
        return 0;
      });

      const top = lst.slice(0,50);
      const table = `
        <table>
          <thead>
            <tr>
              <th>Drill</th>
              <th>Question</th>
              <th class="right">Wrongs</th>
              <th class="right">Attempts</th>
              <th class="right">Accuracy</th>
              <th class="right">Last miss</th>
            </tr>
          </thead>
          <tbody>
            ${top.map(r=>`
              <tr>
                <td><span class="drilltag">${r.drill}</span></td>
                <td class="mono">${r.text}</td>
                <td class="right mono">${r.wrongs||0}</td>
                <td class="right mono">${r.attempts||0}</td>
                <td class="right mono">${r.attempts? (100 - Math.round((r.wrongs/r.attempts)*100))+'%' : '—'}</td>
                <td class="right small">${fmtAgo(r.lastMiss||0)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="small" style="margin-top:.4rem;">Showing top ${top.length} items</div>
      `;
      statsContainer.innerHTML = table;

      const drills=['mixed','mult12','mult10','mult15','div','divZeros','addAll','subAll','squares','cubes','roots','exp2','exp3','exp4','exp5','decimals','add2'];
      const bests = drills.map(d=>`${d}: ${getBest(d)}`).join('  ·  ');
      const bestDiv = document.createElement('div');
      bestDiv.className='small'; bestDiv.style.marginTop='.6rem';
      bestDiv.textContent = `High scores — ${bests}`;
      statsContainer.appendChild(bestDiv);
    }
  </script>
</body>
</html>
